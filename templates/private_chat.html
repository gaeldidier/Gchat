<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Chat with {{ friend.username }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .chat-bubble-right {
            background: #1877f2;
            color: #fff;
            border-radius: 18px 18px 2px 18px;
            word-break: break-word;
           /* display: inline-block; */
            min-width: 60px;
        }
        .chat-bubble-left {
            background: #f0f2f5;
            color: #333;
            border-radius: 18px 18px 18px 2px;
            word-break: break-word;
            /*display: inline-block;*/
            min-width: 60px;
        }
        #chat-box .d-flex {
            align-items: flex-end;
        }
        #chat-box {
            display: flex;
            flex-direction: column;
        }
        body.dark-mode {
            background: #18191a;
            color: #e4e6eb;
        }
    </style>
    <button class="btn btn-outline-secondary toggle-mode" onclick="document.body.classList.toggle('dark-mode')">Toggle Dark/Light Mode</button>
</head>
<body>
<div class="container mt-5">
    <h2>Chat with {{ friend.username }}</h2>
    <div id="notification-global" class="alert alert-info" style="display:none;"></div>
    <div class="row">
        <div class="col-md-8">
            <div id="chat-box" class="mb-3" style="height: 350px; overflow-y: auto; background: #f8f9fa; padding: 10px; border-radius: 8px; border: 1px solid #e0e0e0;">
                {% for message in messages %}
                    {% if message.sender_id == user.id %}
                        <div class="d-flex justify-content-end mb-2 align-items-end">
                            <div class="me-2"></div>
                            <div class="chat-bubble-right p-2 rounded position-relative" style="background: #1877f2; color: #fff; max-width: 70%;">
                                <span>{{ message.content }}</span>
                                <span class="ms-2 small text-light">{{ message.timestamp.strftime('%H:%M') }}</span>
                                {% if message.read %}
                                    <span class="ms-2 text-success small">✔️✔️ Seen</span>
                                {% else %}
                                    <span class="ms-2 text-light small">✔️ Sent</span>
                                {% endif %}
                            </div>
                            <img src="{{ url_for('static', filename='profile_pics/' + (user.profile_pic or 'default.png')) }}" alt="Me" width="32" height="32" class="rounded-circle ms-2">
                        </div>
                    {% else %}
                        <div class="d-flex justify-content-start mb-2 align-items-end">
                            <img src="{{ url_for('static', filename='profile_pics/' + (friend.profile_pic or 'default.png')) }}" alt="Friend" width="32" height="32" class="rounded-circle me-2">
                            <div class="chat-bubble-left p-2 rounded position-relative" style="background: #f0f2f5; color: #333; max-width: 70%;">
                                <span>{{ message.content }}</span>
                                <span class="ms-2 small text-muted">{{ message.timestamp.strftime('%H:%M') }}</span>
                            </div>
                        </div>
                    {% endif %}
                {% else %}
                    <div class="text-muted">No messages yet.</div>
                {% endfor %}
            </div>
            <!-- Chat input removed as requested -->
            <a href="/friends" class="btn btn-secondary mt-3">Back to Friends</a>
        </div>
        <!-- Only chat area and buttons remain -->
    </div>
    {% if is_friend %}
    <form method="POST" class="d-flex" id="chat-form">
        <input type="text" name="message" class="form-control me-2" placeholder="Type your message..." autocomplete="off" required>
        <button type="submit" class="btn btn-primary">Send</button>
    </form>
    <div id="notification" class="alert alert-info mt-2" style="display:none;"></div>
    {% else %}
    <div class="alert alert-warning mt-3">You can only chat with your friends.</div>
    {% endif %}
            <div class="d-flex justify-content-between align-items-center mt-3">
                <a href="/" class="btn btn-secondary">Back to Home</a>
                <form method="POST" class="d-flex" id="chat-form" style="margin-left:auto;">
                    <input type="text" name="message" class="form-control me-2" placeholder="Type your message..." autocomplete="off" required>
                    <button type="submit" class="btn btn-primary">Send</button>
                </form>
            </div>
    <script src="/static/chat.js"></script>
    {% if is_friend %}
    <script>
    pollMessages({{ friend.id|int }});
    let lastMessageCount = {{ messages|length|int }};
    // Global notification polling
    setInterval(function() {
        fetch('/notifications')
            .then(response => response.json())
            .then(data => {
                if (data.notifications && data.notifications.length > 0) {
                    document.getElementById('notification-global').style.display = 'block';
                    document.getElementById('notification-global').innerText = data.notifications.join('\n');
                    setTimeout(() => {
                        document.getElementById('notification-global').style.display = 'none';
                    }, 4000);
                }
            });
    }, 5000);
    // Chat notification for new messages
    setInterval(function() {
        fetch(`/chat/{{ friend.id }}/messages/count`)
            .then(response => response.json())
            .then(data => {
                if (data.count > lastMessageCount) {
                    document.getElementById('notification').style.display = 'block';
                    document.getElementById('notification').innerText = 'New message received!';
                    lastMessageCount = data.count;
                    setTimeout(() => {
                        document.getElementById('notification').style.display = 'none';
                    }, 2000);
                }
            });
    }, 2000);
    </script>
    {% endif %}
</div>
</body>
</html>
