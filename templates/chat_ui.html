<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Chat UI</title>
  <style>
    :root{
      --bg: #0f1320;
      --card: #101b2b;
      --bubble-me: #2d6cdf;
      --bubble-you: #1f2a44;
      --text: #e8eefc;
      --muted: #aab6d6;
    }
    *{box-sizing:border-box}
    body, html { height:100%; margin:0; font-family: system-ui, -apple-system, "Segoe UI"; background:var(--bg); color:var(--text); }
    .chat {
      display:flex; flex-direction:column; height:100%; max-width:900px; margin:0 auto; border:1px solid #1e2a45; border-radius:12px; overflow:hidden;
    }
    .header { padding:12px 16px; background:#0b1220; border-bottom:1px solid #1e2a45; }
    .title { font-weight:600; }
    .messages { flex:1; padding:16px; overflow:auto; background: #0c1422; }
  .message { display:flex; gap:10px; margin:14px 0; align-items:flex-end; }
  .avatar { width:36px; height:36px; border-radius:50%; object-fit:cover; background:#6b7bd6; }
  .bubble { padding:10px 16px; border-radius:18px; max-width:65%; line-height:1.5; position:relative; font-size:1rem; }
  .me { flex-direction:row-reverse; justify-content:flex-end; }
  .me .bubble { background: var(--bubble-me); color:white; border-bottom-right-radius:6px; margin-left:8px; }
  .you { flex-direction:row; justify-content:flex-start; }
  .you .bubble { background: var(--bubble-you); color:white; border-bottom-left-radius:6px; margin-right:8px; }
  .timestamp { font-size:11px; color:var(--muted); margin-top:2px; margin-left:4px; margin-right:4px; }
  .read-receipt { font-size:13px; margin-left:6px; color: #6b7bd6; vertical-align:middle; }
    .composer { display:flex; padding:12px; border-top:1px solid #1e2a45; background:#0f1626; }
    .input { flex:1; padding:12px; border-radius:20px; border:1px solid #334466; outline:none; background:#0b1220; color:var(--text); }
    .send { margin-left:8px; padding:0 14px; border-radius:20px; border:1px solid #2b5bd9; background:#2b5bd9; color:white; cursor:pointer; }
  </style>
</head>
<body>
  <div class="chat" id="chat">
    <div class="header">
      <span class="title">Chat Room</span>
      <span style="float:right; color:var(--muted); font-size:12px;">Online • End-to-end encrypted</span>
    </div>
    <div class="messages" id="messages"></div>
    <div class="composer">
      <input id="text" class="input" placeholder="Type your message..." />
      <button class="send" id="send">Send</button>
    </div>
  </div>

  <script>
    const friendId = {{ friend.id }};
    const api = `/chatui/${friendId}/messages`;
    const msgsEl = document.getElementById('messages');
    const textEl = document.getElementById('text');
    const sendBtn = document.getElementById('send');
    const userName = {{ user.username|tojson }};

    function renderMessage(m, idx){
      const wrap = document.createElement('div');
      const isMe = m.user === userName;
      wrap.className = 'message ' + (isMe ? 'me' : 'you');
      // Avatar
      const avatar = document.createElement('img');
      avatar.className = 'avatar';
      avatar.src = m.profile_pic ? `/static/profile_pics/${m.profile_pic}` : '';
      avatar.alt = m.user;
      // Bubble
      const bubble = document.createElement('div');
      bubble.className = 'bubble';
      bubble.textContent = m.text;
      // Timestamp
      const time = document.createElement('span');
      time.className = 'timestamp';
      time.textContent = m.time;
      bubble.appendChild(time);
      // Read receipt (only for my messages)
      if (isMe && m.read !== undefined) {
        const receipt = document.createElement('span');
        receipt.className = 'read-receipt';
        receipt.textContent = m.read ? '✔✔' : '✔';
        bubble.appendChild(receipt);
      }
      // Arrange
      if (isMe) {
        wrap.appendChild(bubble);
        wrap.appendChild(avatar);
      } else {
        wrap.appendChild(avatar);
        wrap.appendChild(bubble);
      }
      return wrap;
    }

    async function loadHistory(){
      const res = await fetch(api);
      const data = await res.json();
      msgsEl.innerHTML = '';
      (data.history || []).forEach((m, i)=> {
        msgsEl.appendChild(renderMessage(m, i));
      });
      msgsEl.scrollTop = msgsEl.scrollHeight;
    }

    async function sendMessage(){
      const text = textEl.value.trim();
      if(!text) return;
      const payload = { text };
      const res = await fetch(api, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
      if(res.ok){
        textEl.value = '';
        await loadHistory();
      }
    }

    sendBtn.addEventListener('click', sendMessage);
    textEl.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ sendMessage(); } });

    loadHistory();
  </script>
</body>
</html>
